%code requires {
#include <iostream>
#include <string>

// Declaratii externe necesare pentru Flex/Bison
extern "C" int yylex();
extern "C" int yyparse();
extern "C" FILE *yyin;
extern "C" int yylineno; 

// Declararea functiei de eroare in C++
void yyerror(const char *s);
}

%code {
void yyerror(const char *s) {
    std::cerr << "Syntax Error on line " << yylineno << ": " << s << std::endl;
}
}

/***** 1. Definirea Token-urilor (Returnate de Flex) *****/
%token TYPE CLASS_KEYWORD NEW_KEYWORD ID
%token INT_LITERAL FLOAT_LITERAL BOOL_LITERAL STRING_LITERAL
%token ADD SUB MUL DIV MOD
%token EQ NEQ LT GT LE GE AND OR NOT
%token ASSIGN DOT

/***** 2. Precedenta Operatorilor *****/
/* Folosim "left" sau "right" pentru asociativitate. De jos (cea mai mica prec.) in sus (cea mai mare prec.) */
%right ASSIGN
%left OR
%left AND
%left EQ NEQ
%left LT GT LE GE
%left ADD SUB
%left MUL DIV MOD
%right NOT
%right UMINUS // Unary minus (e.g., -5)

%%
/***** 3. Reguli Gramaticale (Gramatica Context-Free) *****/

// Punctul de start
program: statements ;

statements: statement
          | statements statement ;

statement: declaration ';'
         | class_definition
         | expression ';' // Acopera assignment, field access, method call
         | block ;

block: '{' statements '}' ;

// --- Cerinta: Classes ---

// Definitia unei clase
class_definition: CLASS_KEYWORD ID '{' class_body '}' ;

class_body: /* empty */
          | class_body declaration ';' // Campuri (fields)
          | class_body method_definition ;

// Definitia simplificata a unei metode
method_definition: TYPE ID '(' parameters_opt ')' block ; // Metoda nu returneaza valoare

parameters_opt: /* empty */
              | parameters ;

parameters: TYPE ID
          | parameters ',' TYPE ID ;

// Declaratia de variabile/obiecte
declaration: TYPE ID initialization_opt // Ex: int x = 10;
           | ID ID initialization_opt ; // Ex: MyClass obj = new MyClass(); (Primul ID e numele Clasei)

// Sintaxa pentru Initializarea Obiectelor (utilizare 'new')
initialization_opt: /* empty */
                  | ASSIGN expression ; 

arguments_opt: /* empty */
             | expression
             | arguments_opt ',' expression ;

// --- Cerinta: Arithmetic and boolean expressions & Field/Method Access ---

expression: primary_expression
          | expression ADD expression
          | expression SUB expression
          | expression MUL expression
          | expression DIV expression
          | expression MOD expression
          | expression EQ expression
          | expression NEQ expression
          | expression LT expression
          | expression GT expression
          | expression LE expression
          | expression GE expression
          | expression AND expression
          | expression OR expression
          | NOT expression %prec NOT // Negatie unara
          | SUB expression %prec UMINUS // Minus unar
          | ID ASSIGN expression // Assignment simplu (x = 5)
          | member_access ASSIGN expression // Assignment pe un membru (obj.field = 10)
          | NEW_KEYWORD ID '(' arguments_opt ')' // Apel constructor (new MyClass())
          ;

// Accesarea campurilor sau apelul de metode
member_access: ID DOT ID
             | ID DOT ID '(' arguments_opt ')' ;

primary_expression: ID
                  | literal
                  | member_access
                  | '(' expression ')' ;

literal: INT_LITERAL
       | FLOAT_LITERAL
       | BOOL_LITERAL
       | STRING_LITERAL ;
%%